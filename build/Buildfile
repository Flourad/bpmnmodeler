# Signs an update site, using a script that may only be found on the Eclipse Foundation build machine.
# This method may take a long time as signing works as a queue.
def sign(artifact, output = "./signed-#{artifact}")
  
  staging="/home/data/httpd/download-staging.priv/stp"
  system("cp #{artifact} #{staging}")
  system("/usr/bin/sign #{staging}/#{artifact} nomail ${staging}/signed")

  while (!File.exist?"#{staging}/signed/#{artifact}") 
    puts "Signing not complete. Waiting for 2 more minutes..."
    sleep 120
  end
  system("cp ${staging}/signed/#{artifact} #{output}")
  system "rm -rf #{staging}/#{artifact} #{staging}/signed"

end

# Packs an update site (artifact). artifact is the path to a zipped update site
def pack(artifact, output = "./packed-#{artifact}")
 system("java -jar /shared/stp/platforms/releng/M7_34/org.eclipse.releng.basebuilder/plugins/org.eclipse.equinox.launcher.jar -Mmx768m -Dorg.eclipse.update.jarprocessor.pack200=/shared/stp/scripts/pack200 -consolelog -application org.eclipse.update.core.siteOptimizer -jarProcessor -verbose -pack -outputDir /tmp -processAll #{artifact}")
  system("mv /tmp/#{artifact} #{output}")
end

#Digest an update site. The artifact is a zip of an update site.
def digest(artifact, output = "./digested-#{artifact}")
  temp = Dir.tmpdir + "/" + Time.now.to_i
  File.makedirs temp
  system("unzip -oq #{artifact} -d #{temp}")
  system("java -jar /shared/stp/platforms/releng/M7_34/org.eclipse.releng.basebuilder/plugins/org.eclipse.equinox.launcher.jar -application org.eclipse.update.core.siteOptimizer -digestBuilder -digestOutputDir=#{temp} -siteXML=#{temp}/site.xml")
  system("zip -r #{output} #{temp}/*")
  system("rm -Rf #{temp}")
end

# Copies a file for the release "tag" at the right place. The file name is found from the tag by default, but you can override.
def upload(tag, artifact_path = "/shared/stp/#{tag}/digested-packed-signed-site-candidate-#{tag}.zip")
  File.makedirs "~/downloads/stp/committers/updates/#{tag}"
  system("unzip #{artifact_path} -d ~/downloads/stp/committers/updates/#{tag}")
  system("cp #{artifact_path} ~/downloads/stp/committers/updates/")
end
